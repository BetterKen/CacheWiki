# 15 Redis主从架构

在Redis中,用户可以使用`SLAVE OF`命令或者设置`slave of`选项,让一个Redis服务去复制另一个Redis服务,从而来实现类似于Mysql的读写分离

![](http://cache410.oss-cn-beijing.aliyuncs.com/slave.png)



同样的Redis也可以和Mysql一样,做级联模式

## 15.1 旧版复制功能实现

Redis2.8之前Redis的复制分为两个阶段 ： 

- 同步
- 命令传播

### 15.1.1 同步

- 从服务器向主服务器发送SYNC命令
- 收到SYNC命令后，主服务器开始执行BGSAVE操作生成RDB文件，并使用一个缓冲区记录现在开始执行的所有写命令（用于命令传播阶段保持数据库一致性）
- 当主服务器的BGSAVE操作执行完时，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态
- 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令。将自己数据库状态更新至主服务器数据库当前状态

![](http://cache410.oss-cn-beijing.aliyuncs.com/sync.jpg)



### 15.1.2 命令传播

主服务器将执行的写命令，发送给从服务器执行，当从服务器执行了相同写命令后，主从服务器将再次回到一致性状态



### 15.1.3 旧版复制功能的缺陷

**为了让从服务器补足一小部分缺失的数据，而让主服务器重新执行一次BGSAVE操作，造成断线重连后的效率会很低**



## 15.2 新版复制功能的实现

### 15.2.1 SYNC命令换成PSYNC

PSYNC命令具有完整重同步和部分重同步两种模式：

- 完整重同步用于处理初次复制的情况：与SYNC命令的执行步骤基本一致 ， 都是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓冲区里面的写命令来进行同步。
- 部分重同步用于处理断线后重复制的情况：当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接收并执行这些写命令，就可以将数据库更新至主服务器当前所在状态了。



### 15.2.2 部分重同步的实现

- 主从服务器的复制偏移量

- 主服务器的复制积压缓冲区,默认大小为1MB，为安全期间建议按照如下公式设置

  ```
  复制积压缓冲区大小 :
  	2 * second * writer_size_per_second
  	
  second: 从服务断线重连需要的秒数
  writer_size_per_second: 主服务器每秒写书的数据量
  ```

  

- 从服务器记录主服务器运行ID

### 15.2.3 主从复制核心原理

当启动一个 slave node 的时候，它会发送一个 PSYNC 命令给 master node。

如果这是 slave node 初次连接到 master node，那么会触发一次`full resynchronization` 全量复制。此时 master 会启动一个后台线程，开始生成一份 RDB 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。RDB 文件生成完毕后， master 会将这个 RDB 发送给 slave，slave 会先**写入本地磁盘，然后再从本地磁盘加载到内存中**，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据。slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。

![](http://cache410.oss-cn-beijing.aliyuncs.com/redis-master-slave-replication.png)



### 15.2.4 复制完整流程

1. 从服务上设置主服务器的地址和端口
2. 建立socket连接
3. 发送ping命令
4. 身份验证
5. 从服务器发送端口信息
6. 同步
7. 命令传播

### 15.2.5 过期 key 处理

slave 不会过期 key，只会等待 master 过期 key。如果 master 过期了一个 key，或者通过 LRU 淘汰了一个 key，那么会模拟一条 del 命令发送给 slave。



## 15.3 心跳检测

在命令传播阶段,从服务器会每秒向主服务器发送心跳检测,作用如下:

- 检测主从服务器的网络连接状态 看延时多少，一般延时0-1秒
- 辅助实现min-slaves选项
- 检测命令丢失



### 15.3.1 辅助实现min-slaves选项 

Redis的`min-slaves-to-write`和`min-slaves-max-lag`两个选项可以防止主服务器在不安全的情况下执行写命令
举个例子，如果我们向主服务器提供以下设置：

```ini
min-slaves-to-write 3
min-slaves-max-lag 10
```

那么在从服务器的数量少于3个，或者三个从服务器的延迟（lag）值都大于或等于10秒时，主服务器将拒绝执行写命令

### 15.3.2 检测命令丢失

主服务器向从服务器补发缺失数据这一操作的原理和部分重同步操作的原理非常相似，这两个操作的区别在于：**补发缺失数据操作在主从服务器没有断线的情况下执行，而部分重同步操作则在主从服务器断线并重连之后执行**