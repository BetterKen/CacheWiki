# 10 Redis数据结构－object

## 10.1 什么是object

在前面的数个章节里， 我们陆续介绍了 Redis 用到的所有主要数据结构， 比如简单动态字符串（SDS）、双端链表、字典、压缩列表、整数集合， 等等。

Redis 并没有直接使用这些数据结构来实现键值对数据库， 而是基于这些数据结构创建了一个`对象系统`， 这个系统包含字符串对象、列表对象、哈希对象、集合对象和有序集合对象这五种类型的对象， 每种对象都用到了至少一种我们前面所介绍的数据结构。

通过这五种不同类型的对象， Redis 可以在执行命令之前， 根据对象的类型来判断一个对象是否可以执行给定的命令。 使用对象的另一个好处是， 我们可以针对不同的使用场景， 为对象设置多种不同的数据结构实现， 从而优化对象在不同场景下的使用效率



## 10.2 数据结构

```c
#file : src/redis.c
typedef struct redisObject {
    // 类型
    unsigned type:4;
    // 编码
    unsigned encoding:4;
    // 对象最后一次被访问的时间
    unsigned lru:REDIS_LRU_BITS; /* lru time (relative to server.lruclock) */
    // 引用计数
    int refcount;
    // 指向实际值的指针
    void *ptr;
} robj;
```

Redis 使用对象来表示数据库中的键和值， 每次当我们在 Redis 的数据库中新创建一个键值对时， 我们至少会创建两个对象， 一个对象用作键值对的键（键对象）， 另一个对象用作键值对的值（值对象）。



### 10.2.1 type

对象的 type 属性记录了对象的类型:

```c
#file : src/redis.c
// 对象类型
#define REDIS_STRING 0  #字符串对象 "string"
#define REDIS_LIST 1    #列表对象 "list"
#define REDIS_SET 2     #哈希对象 "hash"
#define REDIS_ZSET 3    #集合对象 "set"
#define REDIS_HASH 4    #有序集合对象 "zset"
```



### 10.2.2 encoding

对象的 ptr 指针指向对象的底层实现数据结构， 而这些数据结构由对象的 encoding 属性决定。

encoding 属性记录了对象所使用的编码， 也即是说这个对象使用了什么数据结构作为对象的底层实现:

```c
#file : src/redis.c
// 对象编码
#简单动态字符串
#define REDIS_ENCODING_RAW 0     /* Raw representation */ #long 类型的整数
#long 类型的整数
#define REDIS_ENCODING_INT 1     /* Encoded as integer */
#字典
#define REDIS_ENCODING_HT 2      /* Encoded as hash table */
#压缩字典
#define REDIS_ENCODING_ZIPMAP 3  /* Encoded as zipmap */
#双端链表
#define REDIS_ENCODING_LINKEDLIST 4 /* Encoded as regular linked list */
#压缩列表
#define REDIS_ENCODING_ZIPLIST 5 /* Encoded as ziplist */
#整数集合
#define REDIS_ENCODING_INTSET 6  /* Encoded as intset */
#跳表
#define REDIS_ENCODING_SKIPLIST 7  /* Encoded as skiplist */
#embstr编码的简单动态字符串
#define REDIS_ENCODING_EMBSTR 8  /* Embedded sds string encoding */
```

