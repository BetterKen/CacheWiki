# 17 RedisCluster

## 17.1 redis cluster介绍

![](http://cache410.oss-cn-beijing.aliyuncs.com/rediscluster.png)



- 自动将数据进行分片,每个master上放一部分数据
- 提供内置的高可用支持,部分master不可用时,还是可以继续工作的，因为每个master都有salve节点，那么如果mater挂掉，redis cluster这套机制，就会自动将某个slave切换成master；
- 支持读写分离：对于每个master来说，都负责写请求，写就写到master，然后读就从mater对应的slave去读；

redisCluster是Redis的官方分布式解决方案,解决了上一章提到的Redis主从模式的1,2,3缺陷

redisCluster = 多master+读写分离+sentinal



## 17.2 分区规则 

### 17.2.1 常见分区规则

分布式数据库首要解决把整个数据集按照分区规则映射到多个节点的问题，即把数据集划分到多个节点上，每个节点负责整个数据的一个子集。

常见的分区规则有`哈希分区和顺序分区`。Redis Cluster采用哈希分区规则，因此接下来会讨论哈希分区规则。常见的哈希分区有以下几种：

- 节点取余分区
- 一致性哈希分区
- 虚拟槽分区

Redis Cluster采用虚拟槽分区

### 17.2.2 redis使用的hash slot

虚拟槽分区巧妙地使用了哈希空间，使用分散度良好的哈希函数把所有的数据映射到一个固定范围内的整数集合，整数定义为槽（slot）。

redis cluster有固定的16384个hash slot，对每个key计算CRC16值，然后对16384取模，可以获取key对应的hash slot
redis cluster中每个master都会持有部分slot，比如有3个master，那么可能每个master持有5000多个hash slot
hash slot让node的增加和移除很简单，增加一个master，就将其他master的hash slot移动部分过去，减少一个master，就将它的hash slot移动到其他master上去
移动hash slot的成本是非常低的
客户端的api，可以对指定的数据，让他们走同一个hash slot，通过hash tag来实现出处。







## Redis cluster功能限制

Redis集群相对单机在功能上有一定限制:

- key批量操作支持有限。如：MSET,MGET，目前只支持具有相同slot值的key执行批量操作。
- key事务操作支持有限。支持多key在同一节点上的事务操作，不支持分布在多个节点的事务功能。
- key作为数据分区的最小粒度，因此不能将一个大的键值对象映射到不同的节点。如：hash、list。
- 不支持多数据库空间。单机下Redis支持16个数据库，集群模式下只能使用一个数据库空间，即db0。
- 复制结构只支持一层，不支持嵌套树状复制结构。

## 